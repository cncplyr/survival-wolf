<!DOCTYPE html>
<html>
<head>
	<!-- 3rd Party -->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
	<link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
	<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
	<!-- Ours -->
	<script src="map.js"></script>
	<script src="game.js"></script>
	<script src="animals-base.js"></script>
	<script src="animals-wolves.js"></script>
	
	<style>
		body{background-color:#1C2536;}
	</style>
</head>
<body>
<br><br>
	<div class="container">
		<div class="row">
			<div class="col-sm-8 col-md-8">
				<canvas id="grid" width="800" height="800"></canvas>
			</div>
			<div class="col-sm-4 col-md-4">
				<div class="panel panel-default">
					<div class="panel-body">
						<button type="button" class="btn btn-default btn-block" onclick="newGame();">New Game</button>
						<button type="button" class="btn btn-default btn-block" id="run" onclick="toggleRun();">Run</button>
		
						<br>
						
						<span>Progress:</span><br>
						<div class="progress">
							<div id="info-progressbar" class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%;">0%</div>
						</div>
						
						<br>
						
						<ul class="nav nav-pills nav-stacked">
							<li class="active"><a href="#"><span id="count-stone" class="badge pull-right">100</span>Stone</a></li>
							<li class="active"><a href="#"><span id="count-lion" class="badge pull-right">100</span>Lion</a></li>
							<li class="active"><a href="#"><span id="count-bear" class="badge pull-right">100</span>Bear</a></li>
						</ul>
						
						<br>
						<h3>Rules</h3>
						<P>Starts with 100 of each animal.</p>
						<P>Each turn animals may move once.</p>
						<p>When animals meet, they fight to the death.</p>
						<p>Games last 500 turns.</p>
						<p>The winner is the animal with the most remaining at the end.</p>
						
					</div>
				</div>
			</div>
		</div>
	</div>
	
	<script type="text/javascript">
	var canvas;
	var game;
	var running = false;
	
	/* Button actions */
	
	function newGame(){
		game.newGame();
		
		// Populate the game with the basic animals
		game.populate(animalsBase, 100);
		
		// TODO: Populate the game with wolves
		//game.populate(animalsWolves);
				
		// Update the map and info
		infoNewGame();
		if (running) { infoUpdateGame(); }
		draw();
	}
	
	function run(){
		if (running && !game.isFinished()) {
			game.next();
			draw();
		} else if (game.isFinished()){
			infoEndGame();
		}
	}
	
	function toggleRun(){
		if (game.isFinished()){
			running = false;
			// Reset so we can start a new game
			newGame();
		} else {
			running = running ? false : true;
			infoUpdateGame();
		}
	}
	
	/* Iamge display */
	var loadedCount = 0;
	var wolf = new Image();
	wolf.src = 'images/animal-wolf.png';
	wolf.addEventListener('load', function(){animalLoaded();}, false);
	var stone = new Image();
	stone.src = 'images/animal-stone.png';
	stone.addEventListener('load', function(){animalLoaded();}, false);
	var lion = new Image();
	lion.src = 'images/animal-lion.png';
	lion.addEventListener('load', function(){animalLoaded();}, false);
	var bear = new Image();
	bear.src = 'images/animal-bear.png';
	bear.addEventListener('load', function(){animalLoaded();}, false);
	
	function animalLoaded(){
		console.log('loaded');
		loadedCount++;
		if (loadedCount > 3) {
			newGame();
		}
	}
	
	/* Map display */
	
	function draw() {
		canvas.width = canvas.width; // clears the canvas
		var ctx = canvas.getContext("2d");
		size = game.blockSize;
	
		// draw all the circles
		// TODO: Fix the drawing bug here
		for(var x = 0; x < game.mapSize; x++){
			for(var y = 0; y < game.mapSize; y++){
				if(game.map[x][y] != null) {
					// Set the colour for that animal
					switch(game.map[x][y].name()){
						case "l" :
							// Lions are yellow
							ctx.drawImage(lion, x*size, y*size, 10, 10);
							ctx.fillStyle = "rgb(255,247,115)";
							break;
						case "b" :
							// Bears are orange
							ctx.drawImage(bear, x*size, y*size, 10, 10);
							ctx.fillStyle = "rgb(255,174,115)";
							break;
						case "s" :
							// Stones are green 
							ctx.drawImage(stone, x*size, y*size, 10, 10);
							ctx.fillStyle = "rgb(93,207,195)";
							break;
						case "w" :
							// Wolves are purple
							ctx.drawImage(wolf, x*size, y*size, 10, 10);
							ctx.fillStyle = "rgb(160,105,214)";
							break;
					}
					// Draw a circle where the animal is
					/*
					ctx.moveTo(x*size+(size/2),y*size);
					ctx.beginPath();
					ctx.arc(x*size, y*size, size/2, 0, 2*Math.PI);
					ctx.closePath();
					ctx.fill();
					*/
				}
			}
		}
		
		// Update the info panel
		infoUpdateGame();
	}	
	
	/* Info display */
	
	function infoNewGame() {
		// Progress bar
		$('#info-progressbar').removeClass('progress-bar-success');
		// ToggleRun button
		$('#run').text('Start!').removeClass('btn-danger').addClass('btn-success');
	}
	
	function infoUpdateGame() {
		// Progress bar
		var progress = game.getProgress();
		$('#info-progressbar').attr('aria-valuenow', progress).attr('style', 'width:' + progress + '%;').text(progress + '%');
		// Animal counts
		$('#count-stone').text(animalsBaseCount['s']);
		$('#count-lion').text(animalsBaseCount['l']);
		$('#count-bear').text(animalsBaseCount['b']);
		// ToggleRun button
		if (running) {
			$('#run').text('Pause').removeClass('btn-success').addClass('btn-danger');
		} else {
			if (game.currentTurn == 0) {
				$('#run').text('Start!').removeClass('btn-danger').addClass('btn-success');
			} else {
				$('#run').text('Continue').removeClass('btn-danger').addClass('btn-success');				
			}
		}
	}	
	
	function infoEndGame(){
		// Progress bar
		$('#info-progressbar').addClass('progress-bar-success');
		// ToggleRun button
		$('#run').text('Game Finished!').removeClass('btn-succes').addClass('btn-danger');
	}
	
	function init(blockSize, mapSize) {
		canvas = document.getElementById('grid');
		
		game = new SurvivalGame(blockSize, mapSize);
		
		// Note: newGame() call is in image load callback
		
		setInterval('run()', 50);
	}
		
	init(5, 150);
	

	</script>
</body>
</html>